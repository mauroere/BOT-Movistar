<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üçΩÔ∏è Test - Nodos de Men√∫</title>
    <link rel="stylesheet" href="visual-editor/visual-editor.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 1200px;
        margin: 0 auto;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .test-section {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .canvas-section {
        flex: 2;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fafafa;
      }
      .properties-section {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fafafa;
      }
      #visual-canvas {
        width: 100%;
        height: 400px;
        position: relative;
      }
      #properties-panel {
        width: 100%;
        height: 400px;
        padding: 10px;
        overflow-y: auto;
      }
      .step-info {
        background: #f8f9fa;
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid #007bff;
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üçΩÔ∏è Test de Nodos de Men√∫ - Editor Visual</h1>
      <p>
        Este test espec√≠ficamente prueba la funcionalidad de guardar y
        visualizar opciones de men√∫.
      </p>

      <div class="status info">
        <strong>üéØ Problema identificado:</strong>
        Las opciones de la caja de men√∫ no se guardan ni se visualizan
        correctamente.
      </div>

      <div class="status success">
        <strong>‚úÖ Soluciones implementadas:</strong>
        <ul style="margin: 5px 0">
          <li>Eventos de array-input mejorados para capturar cambios</li>
          <li>Visualizaci√≥n espec√≠fica de opciones de men√∫ en los nodos</li>
          <li>Estilos CSS para mostrar opciones visualmente</li>
          <li>Logging para debug de propiedades de array</li>
        </ul>
      </div>

      <div style="margin: 15px 0">
        <button onclick="initEditor()">üöÄ Inicializar Editor</button>
        <button onclick="createMenuNode()">üçΩÔ∏è Crear Nodo de Men√∫</button>
        <button onclick="testMenuOptions()">üß™ Test Opciones de Men√∫</button>
        <button onclick="showNodeData()">üìä Ver Datos del Nodo</button>
        <button onclick="clearCanvas()">üóëÔ∏è Limpiar</button>
      </div>

      <div class="test-section">
        <div class="canvas-section">
          <h3>Canvas del Editor</h3>
          <div id="visual-canvas"></div>
        </div>
        <div class="properties-section">
          <h3>Panel de Propiedades</h3>
          <div id="properties-panel">
            <div id="properties-content">
              <p style="color: #666; text-align: center; padding: 20px">
                Selecciona un nodo para ver sus propiedades
              </p>
            </div>
          </div>
        </div>
      </div>

      <h3>üìä Log de Pruebas:</h3>
      <div id="test-results"></div>

      <div class="status warning" style="margin-top: 20px">
        <h4>üß™ Pasos de la prueba:</h4>
        <div class="step-info">
          <strong>Paso 1:</strong> Inicializar el editor y crear un nodo de men√∫
        </div>
        <div class="step-info">
          <strong>Paso 2:</strong> Configurar el t√≠tulo del men√∫ (ej: "Men√∫
          Principal")
        </div>
        <div class="step-info">
          <strong>Paso 3:</strong> Agregar opciones usando el bot√≥n "+ Agregar"
        </div>
        <div class="step-info">
          <strong>Paso 4:</strong> Verificar que las opciones aparezcan en el
          nodo visual
        </div>
        <div class="step-info">
          <strong>Paso 5:</strong> Confirmar que los datos se guarden
          correctamente
        </div>
      </div>
    </div>

    <!-- Cargar todos los m√≥dulos necesarios del editor visual -->
    <script src="visual-editor/visual-config.js"></script>
    <script src="visual-editor/visual-node-manager.js"></script>
    <script src="visual-editor/visual-connection-manager.js"></script>
    <script src="visual-editor/visual-flow-converter.js"></script>
    <script src="visual-editor/visual-drag-drop.js"></script>
    <script src="visual-editor/visual-properties-panel.js"></script>
    <script src="visual-editor/visual-validation-panel.js"></script>
    <script src="visual-editor/visual-editor.js"></script>

    <script>
      let testResults = document.getElementById("test-results");
      let currentMenuNodeId = null;

      function log(message, type = "info") {
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
        testResults.appendChild(div);
        testResults.scrollTop = testResults.scrollHeight;
      }

      function initEditor() {
        log("üöÄ <strong>Inicializando Editor Visual...</strong>");

        try {
          if (typeof window.VisualEditor !== "undefined") {
            window.VisualEditor.init();
            log("‚úÖ Editor inicializado correctamente", "success");

            // Configurar el panel de propiedades
            if (typeof window.VisualPropertiesPanel !== "undefined") {
              window.VisualPropertiesPanel.init();
              log("‚úÖ Panel de propiedades inicializado", "success");
            }
          } else {
            log("‚ùå Error: VisualEditor no est√° disponible", "error");
          }
        } catch (error) {
          log(
            `‚ùå <strong>Error durante la inicializaci√≥n:</strong> ${error.message}`,
            "error"
          );
          console.error("Error de inicializaci√≥n:", error);
        }
      }

      function createMenuNode() {
        log("üçΩÔ∏è <strong>Creando nodo de men√∫...</strong>");

        try {
          // Crear un nodo de tipo men√∫ en el centro del canvas
          const menuNode = window.VisualNodeManager.createNode("menu", {
            x: 200,
            y: 150,
          });

          if (menuNode) {
            currentMenuNodeId = menuNode.id;
            log(
              `‚úÖ <strong>Nodo de men√∫ creado:</strong> ID=${menuNode.id}`,
              "success"
            );

            // Seleccionar autom√°ticamente el nodo para mostrar las propiedades
            setTimeout(() => {
              window.VisualNodeManager.selectNode(menuNode.id);
              log(
                "‚úÖ Nodo seleccionado - panel de propiedades actualizado",
                "success"
              );
            }, 100);
          } else {
            log("‚ùå Error al crear nodo de men√∫", "error");
          }
        } catch (error) {
          log(
            `‚ùå <strong>Error creando nodo de men√∫:</strong> ${error.message}`,
            "error"
          );
          console.error("Error creando nodo:", error);
        }
      }

      function testMenuOptions() {
        log("üß™ <strong>Iniciando test de opciones de men√∫...</strong>");

        if (!currentMenuNodeId) {
          log("‚ö†Ô∏è Primero crea un nodo de men√∫", "warning");
          return;
        }

        try {
          const menuNode = window.VisualNodeManager.getNode(currentMenuNodeId);
          if (!menuNode) {
            log("‚ùå Nodo de men√∫ no encontrado", "error");
            return;
          }

          // Configurar propiedades de ejemplo
          menuNode.properties.title = "Men√∫ Principal";
          menuNode.properties.text = "Selecciona una opci√≥n:";
          menuNode.properties.options = [
            "Ver mi saldo",
            "Consultar facturas",
            "Servicios t√©cnicos",
            "Hablar con un agente",
          ];

          // Actualizar la visualizaci√≥n
          window.VisualNodeManager.updateNodeContent(currentMenuNodeId);

          // Actualizar el panel de propiedades si el nodo est√° seleccionado
          if (
            window.VisualPropertiesPanel.currentNode &&
            window.VisualPropertiesPanel.currentNode.id === currentMenuNodeId
          ) {
            window.VisualPropertiesPanel.updateProperties(menuNode);
          }

          log("‚úÖ <strong>Opciones de men√∫ configuradas:</strong>", "success");
          menuNode.properties.options.forEach((option, index) => {
            log(`&nbsp;&nbsp;&nbsp;${index + 1}. ${option}`, "info");
          });

          log(
            "üîç Verifica que las opciones aparezcan en el nodo visual",
            "info"
          );
        } catch (error) {
          log(
            `‚ùå <strong>Error en test de opciones:</strong> ${error.message}`,
            "error"
          );
          console.error("Error en test:", error);
        }
      }

      function showNodeData() {
        log("üìä <strong>Mostrando datos de todos los nodos...</strong>");

        try {
          const nodes = window.VisualNodeManager.getAllNodes();

          if (nodes.length === 0) {
            log("‚ÑπÔ∏è No hay nodos en el canvas", "info");
            return;
          }

          log(`üìä <strong>Total de nodos:</strong> ${nodes.length}`, "info");

          nodes.forEach((node) => {
            log(`<strong>Nodo ${node.id}:</strong> Tipo=${node.type}`, "info");

            if (node.properties) {
              Object.entries(node.properties).forEach(([key, value]) => {
                if (Array.isArray(value)) {
                  log(
                    `&nbsp;&nbsp;&nbsp;${key}: [${
                      value.length
                    } elementos] = [${value.join(", ")}]`,
                    "info"
                  );
                } else {
                  log(`&nbsp;&nbsp;&nbsp;${key}: ${value}`, "info");
                }
              });
            }
          });
        } catch (error) {
          log(
            `‚ùå <strong>Error mostrando datos:</strong> ${error.message}`,
            "error"
          );
          console.error("Error mostrando datos:", error);
        }
      }

      function clearCanvas() {
        try {
          const canvas = document.getElementById("visual-canvas");
          if (canvas) {
            canvas.innerHTML = "";
          }

          // Limpiar los datos del NodeManager si existe
          if (window.VisualNodeManager && window.VisualNodeManager.nodes) {
            window.VisualNodeManager.nodes.clear();
          }

          currentMenuNodeId = null;
          testResults.innerHTML = "";

          log("üóëÔ∏è Canvas limpiado correctamente", "success");
        } catch (error) {
          log(`‚ùå Error limpiando canvas: ${error.message}`, "error");
        }
      }

      // Inicializaci√≥n autom√°tica al cargar la p√°gina
      document.addEventListener("DOMContentLoaded", function () {
        log(
          "üöÄ <strong>Test de nodos de men√∫ cargado.</strong> Listo para probar!",
          "success"
        );

        // Configurar el contenedor de propiedades para que el panel funcione
        const propertiesContainer =
          document.getElementById("properties-content");
        if (
          propertiesContainer &&
          !document.getElementById("properties-content")
        ) {
          // El contenedor ya existe con el ID correcto
          console.log("Container de propiedades configurado correctamente");
        }
      });
    </script>
  </body>
</html>

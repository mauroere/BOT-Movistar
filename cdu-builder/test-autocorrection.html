<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîß Test de Auto-correcci√≥n</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .test-container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
      }
      .status {
        padding: 15px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      #results {
        margin-top: 20px;
        min-height: 100px;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>üîß Test de Auto-correcci√≥n - ConnectionManager</h1>

      <div class="status info">
        <h3>üéØ Problema Resuelto</h3>
        <p>
          <strong>Error original:</strong>
          <code>getAllConnections is not a function</code>
        </p>
        <p>
          <strong>Soluci√≥n:</strong> Agregado m√©todo
          <code>getAllConnections()</code> como alias de
          <code>getConnections()</code>
        </p>
      </div>

      <button onclick="testConnectionManager()">
        üß™ Test ConnectionManager
      </button>
      <button onclick="testAutoCorrection()">üîß Test Auto-correcci√≥n</button>
      <button onclick="testValidationPanel()">
        ‚úÖ Test Panel de Validaci√≥n
      </button>

      <div id="results"></div>
    </div>

    <!-- Cargar m√≥dulos necesarios -->
    <script src="visual-editor/visual-editor-config.js"></script>
    <script src="visual-editor/visual-node-manager.js"></script>
    <script src="visual-editor/visual-connection-manager.js"></script>
    <script src="visual-editor/visual-validation-panel.js"></script>

    <script>
      function log(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `status ${type}`;
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      function testConnectionManager() {
        log("üß™ <strong>Probando ConnectionManager...</strong>");

        try {
          // Test 1: Verificar que existe
          if (typeof window.VisualConnectionManager === "undefined") {
            log("‚ùå VisualConnectionManager no est√° definido", "error");
            return;
          }
          log("‚úÖ VisualConnectionManager est√° disponible", "success");

          // Test 2: Verificar m√©todo getConnections
          if (
            typeof window.VisualConnectionManager.getConnections === "function"
          ) {
            const connections1 =
              window.VisualConnectionManager.getConnections();
            log("‚úÖ getConnections() funciona correctamente", "success");
            log(`üìä Conexiones encontradas: ${connections1.length}`, "info");
          } else {
            log("‚ùå getConnections() no es una funci√≥n", "error");
          }

          // Test 3: Verificar m√©todo getAllConnections (el que causaba el error)
          if (
            typeof window.VisualConnectionManager.getAllConnections ===
            "function"
          ) {
            const connections2 =
              window.VisualConnectionManager.getAllConnections();
            log(
              "‚úÖ getAllConnections() ahora funciona correctamente",
              "success"
            );
            log(`üìä Conexiones encontradas: ${connections2.length}`, "info");
          } else {
            log("‚ùå getAllConnections() no es una funci√≥n", "error");
          }

          // Test 4: Verificar que ambos m√©todos devuelven lo mismo
          const conn1 = window.VisualConnectionManager.getConnections();
          const conn2 = window.VisualConnectionManager.getAllConnections();
          if (conn1.length === conn2.length) {
            log("‚úÖ Ambos m√©todos devuelven el mismo resultado", "success");
          } else {
            log("‚ö†Ô∏è Los m√©todos devuelven resultados diferentes", "warning");
          }
        } catch (error) {
          log(`‚ùå <strong>Error:</strong> ${error.message}`, "error");
          console.error("Error en test:", error);
        }
      }

      function testAutoCorrection() {
        log("üîß <strong>Probando Auto-correcci√≥n...</strong>");

        try {
          // Verificar que el m√≥dulo de validaci√≥n existe
          if (typeof window.VisualValidationPanel === "undefined") {
            log("‚ùå VisualValidationPanel no est√° definido", "error");
            return;
          }
          log("‚úÖ VisualValidationPanel est√° disponible", "success");

          // Verificar que la funci√≥n autoFix existe
          if (typeof window.VisualValidationPanel.autoFix === "function") {
            log("‚úÖ Funci√≥n autoFix disponible", "success");

            // Ejecutar auto-correcci√≥n
            try {
              window.VisualValidationPanel.autoFix();
              log("‚úÖ Auto-correcci√≥n ejecutada sin errores", "success");
            } catch (autoFixError) {
              log(
                `‚ùå Error en auto-correcci√≥n: ${autoFixError.message}`,
                "error"
              );
            }
          } else {
            log("‚ùå Funci√≥n autoFix no disponible", "error");
          }
        } catch (error) {
          log(`‚ùå <strong>Error:</strong> ${error.message}`, "error");
          console.error("Error en test:", error);
        }
      }

      function testValidationPanel() {
        log("‚úÖ <strong>Probando Panel de Validaci√≥n...</strong>");

        try {
          // Test completo del sistema de validaci√≥n
          if (window.VisualValidationPanel) {
            // Test 1: Inicializaci√≥n
            if (typeof window.VisualValidationPanel.init === "function") {
              window.VisualValidationPanel.init();
              log("‚úÖ Panel de validaci√≥n inicializado", "success");
            }

            // Test 2: Funci√≥n validate
            if (typeof window.VisualValidationPanel.validate === "function") {
              try {
                const result = window.VisualValidationPanel.validate();
                log("‚úÖ Funci√≥n validate ejecutada correctamente", "success");
              } catch (validateError) {
                log(`‚ùå Error en validate: ${validateError.message}`, "error");
              }
            }

            log("üéâ <strong>Todas las pruebas completadas</strong>", "success");
          } else {
            log("‚ùå VisualValidationPanel no disponible", "error");
          }
        } catch (error) {
          log(`‚ùå <strong>Error:</strong> ${error.message}`, "error");
          console.error("Error en test:", error);
        }
      }

      // Inicializaci√≥n autom√°tica
      document.addEventListener("DOMContentLoaded", function () {
        log("üöÄ <strong>Test de auto-correcci√≥n iniciado</strong>", "info");
        log(
          'üîç El problema "getAllConnections is not a function" deber√≠a estar resuelto',
          "info"
        );

        // Test autom√°tico al cargar
        setTimeout(() => {
          testConnectionManager();
        }, 1000);
      });
    </script>
  </body>
</html>

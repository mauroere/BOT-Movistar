<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CDU Builder Pro - Generador de Flujos WhatsApp</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="visual-editor/visual-editor.css" />
    <link rel="stylesheet" href="visual-editor/visual-editor.css" />
  </head>
  <body>
    <div class="builder-header">
      <h1>ğŸ”§ CDU Builder Pro</h1>
      <p>
        Generador, Previsualizador y Desplegador AutomÃ¡tico de Flujos - WhatsApp
        Bot Movistar Empresas
      </p>
    </div>

    <!-- NavegaciÃ³n por pestaÃ±as -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button class="tab-btn active" data-tab="config">
          âš™ï¸ ConfiguraciÃ³n
        </button>
        <button class="tab-btn" data-tab="visual">ğŸ¨ Editor Visual</button>
        <button class="tab-btn" data-tab="preview">ğŸ‘ï¸ PrevisualizaciÃ³n</button>
        <button class="tab-btn" data-tab="code">ğŸ“„ CÃ³digo</button>
        <button class="tab-btn" data-tab="deploy">ğŸš€ Despliegue</button>
      </div>
    </div>

    <!-- TAB 1: ConfiguraciÃ³n -->
    <div class="tab-content active" id="config-tab">
      <div class="builder-container">
        <!-- ConfiguraciÃ³n BÃ¡sica -->
        <div class="builder-section">
          <h3 class="section-title">âš™ï¸ ConfiguraciÃ³n BÃ¡sica</h3>

          <div class="form-group">
            <label class="form-label">Nombre del CDU (sin espacios) *:</label>
            <input
              type="text"
              id="cduName"
              class="form-input"
              placeholder="ej: soporte_tecnico"
              required
            />
            <small style="color: #666"
              >Solo letras, nÃºmeros y guiones bajos</small
            >
          </div>

          <div class="form-group">
            <label class="form-label">TÃ­tulo para mostrar *:</label>
            <input
              type="text"
              id="cduTitle"
              class="form-input"
              placeholder="ej: CDU Soporte TÃ©cnico"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label">DescripciÃ³n breve *:</label>
            <input
              type="text"
              id="cduDescription"
              class="form-input"
              placeholder="ej: Asistencia tÃ©cnica especializada"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label">Icono (Font Awesome):</label>
            <input
              type="text"
              id="cduIcon"
              class="form-input"
              placeholder="ej: fas fa-tools"
              value="fas fa-cog"
            />
            <small style="color: #666"
              >Busca Ã­conos en
              <a href="https://fontawesome.com/icons" target="_blank"
                >FontAwesome</a
              ></small
            >
          </div>
        </div>

        <!-- Mensajes y Opciones -->
        <div class="builder-section">
          <h3 class="section-title">ğŸ’¬ Contenido del Flujo</h3>

          <div class="form-group">
            <label class="form-label">Mensaje inicial *:</label>
            <textarea
              id="initialMessage"
              class="form-input form-textarea"
              placeholder="Â¡Hola! Te ayudo con..."
              required
            ></textarea>
            <small style="color: #666"
              >Este serÃ¡ el primer mensaje que vea el usuario</small
            >
          </div>

          <div class="form-group">
            <label class="form-label">Mensaje adicional (opcional):</label>
            <textarea
              id="secondMessage"
              class="form-input form-textarea"
              placeholder="Selecciona una opciÃ³n..."
            ></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Opciones de respuesta *:</label>
            <div class="options-container" id="optionsContainer">
              <!-- Las opciones se agregan dinÃ¡micamente -->
            </div>
            <button
              type="button"
              class="btn btn-secondary"
              onclick="CDUBuilder.addOption()"
            >
              â• Agregar OpciÃ³n
            </button>
            <small style="color: #666">Al menos una opciÃ³n es requerida</small>
          </div>
        </div>

        <!-- Plantillas RÃ¡pidas -->
        <div class="builder-section">
          <h3 class="section-title">ğŸ“‹ Plantillas RÃ¡pidas</h3>

          <div class="template-buttons">
            <button
              class="btn btn-primary"
              onclick="CDUBuilder.loadTemplate('soporte')"
            >
              ğŸ”§ Soporte TÃ©cnico
            </button>
            <button
              class="btn btn-primary"
              onclick="CDUBuilder.loadTemplate('facturacion')"
            >
              ğŸ’° FacturaciÃ³n
            </button>
            <button
              class="btn btn-primary"
              onclick="CDUBuilder.loadTemplate('comercial')"
            >
              ğŸ›ï¸ Comercial
            </button>
            <button
              class="btn btn-primary"
              onclick="CDUBuilder.loadTemplate('reclamos')"
            >
              ğŸ“ Reclamos
            </button>
          </div>
        </div>

        <!-- ConfiguraciÃ³n Avanzada -->
        <div class="builder-section">
          <h3 class="section-title">ğŸ›ï¸ ConfiguraciÃ³n Avanzada</h3>

          <div class="form-group">
            <label class="form-label">Autor:</label>
            <input
              type="text"
              id="author"
              class="form-input"
              placeholder="Tu nombre"
              value="CDU Builder Pro"
            />
          </div>

          <div class="form-group">
            <label class="form-label">VersiÃ³n:</label>
            <input
              type="text"
              id="version"
              class="form-input"
              placeholder="1.0"
              value="1.0"
            />
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="enableStats" /> Habilitar estadÃ­sticas
              de uso
            </label>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="enableLogging" checked /> Habilitar
              logging de debug
            </label>
          </div>

          <div style="margin-top: 20px">
            <button
              class="btn btn-primary"
              onclick="CDUBuilder.validateAndPreview()"
            >
              ğŸ‘ï¸ Previsualizar
            </button>
            <button
              class="btn btn-success"
              onclick="CDUBuilder.validateAndGenerate()"
            >
              ğŸ“„ Generar CÃ³digo
            </button>
            <button class="btn btn-secondary" onclick="CDUBuilder.clearAll()">
              ğŸ—‘ï¸ Limpiar Todo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 2: Editor Visual -->
    <div class="tab-content" id="visual-tab">
      <div class="visual-editor-container">
        <!-- Barra de herramientas -->
        <div class="toolbar">
          <div class="toolbar-section">
            <button id="visual-new" class="btn btn-icon" title="Nuevo flujo">
              <i class="fas fa-file"></i>
            </button>
            <button id="visual-open" class="btn btn-icon" title="Abrir flujo">
              <i class="fas fa-folder-open"></i>
            </button>
            <button id="visual-save" class="btn btn-icon" title="Guardar flujo">
              <i class="fas fa-save"></i>
            </button>
          </div>

          <div class="toolbar-section">
            <button
              id="visual-undo"
              class="btn btn-icon"
              title="Deshacer (Ctrl+Z)"
            >
              <i class="fas fa-undo"></i>
            </button>
            <button
              id="visual-redo"
              class="btn btn-icon"
              title="Rehacer (Ctrl+Y)"
            >
              <i class="fas fa-redo"></i>
            </button>
          </div>

          <div class="toolbar-section">
            <button id="visual-zoom-in" class="btn btn-icon" title="Acercar">
              <i class="fas fa-search-plus"></i>
            </button>
            <button id="visual-zoom-out" class="btn btn-icon" title="Alejar">
              <i class="fas fa-search-minus"></i>
            </button>
            <button id="visual-zoom-fit" class="btn btn-icon" title="Ajustar">
              <i class="fas fa-expand-arrows-alt"></i>
            </button>
          </div>

          <div class="toolbar-section">
            <button
              id="visual-validate"
              class="btn btn-primary"
              title="Validar flujo"
            >
              <i class="fas fa-check"></i> Validar
            </button>
            <button
              id="visual-generate"
              class="btn btn-success"
              title="Generar CDU"
            >
              <i class="fas fa-code"></i> Generar CDU
            </button>
          </div>

          <div class="toolbar-section">
            <button
              onclick="window.open('test-menu-destinations.html', '_blank')"
              class="btn btn-info"
              title="Test de MenÃºs con Destinos"
            >
              <i class="fas fa-link"></i> Test MenÃºs
            </button>
            <button
              onclick="window.open('validation-final.html', '_blank')"
              class="btn btn-warning"
              title="ValidaciÃ³n Completa del Sistema"
            >
              <i class="fas fa-clipboard-check"></i> ValidaciÃ³n
            </button>
          </div>
        </div>

        <!-- Contenedor principal del editor -->
        <div class="visual-editor">
          <!-- Panel de componentes -->
          <div class="components-panel">
            <h4>ğŸ§© Componentes</h4>

            <div class="component-category">
              <h5>ğŸ“¨ Mensajes</h5>
              <div class="component-group">
                <div
                  class="component-item"
                  draggable="true"
                  data-type="send-message"
                >
                  <div class="component-icon">ğŸ’¬</div>
                  <span>Enviar Mensaje</span>
                </div>
                <div
                  class="component-item"
                  draggable="true"
                  data-type="send-image"
                >
                  <div class="component-icon">ğŸ–¼ï¸</div>
                  <span>Enviar Imagen</span>
                </div>
                <div
                  class="component-item"
                  draggable="true"
                  data-type="send-audio"
                >
                  <div class="component-icon">ğŸ”Š</div>
                  <span>Enviar Audio</span>
                </div>
                <div
                  class="component-item"
                  draggable="true"
                  data-type="send-video"
                >
                  <div class="component-icon">ğŸ¥</div>
                  <span>Enviar Video</span>
                </div>
              </div>
            </div>

            <div class="component-category">
              <h5>ğŸ® Interacciones</h5>
              <div class="component-group">
                <div
                  class="component-item"
                  draggable="true"
                  data-type="wait-message"
                >
                  <div class="component-icon">â³</div>
                  <span>Esperar Respuesta</span>
                </div>
                <div
                  class="component-item"
                  draggable="true"
                  data-type="quick-reply"
                >
                  <div class="component-icon">âš¡</div>
                  <span>Respuesta RÃ¡pida</span>
                </div>
                <div class="component-item" draggable="true" data-type="menu">
                  <div class="component-icon">ğŸ“‹</div>
                  <span>MenÃº</span>
                </div>
                <div class="component-item" draggable="true" data-type="button">
                  <div class="component-icon">ğŸ”˜</div>
                  <span>BotÃ³n</span>
                </div>
              </div>
            </div>

            <div class="component-category">
              <h5>ğŸ”„ Control de Flujo</h5>
              <div class="component-group">
                <div
                  class="component-item"
                  draggable="true"
                  data-type="condition"
                >
                  <div class="component-icon">â“</div>
                  <span>CondiciÃ³n</span>
                </div>
                <div class="component-item" draggable="true" data-type="delay">
                  <div class="component-icon">â±ï¸</div>
                  <span>Delay</span>
                </div>
                <div class="component-item" draggable="true" data-type="jump">
                  <div class="component-icon">ğŸ”„</div>
                  <span>Saltar a</span>
                </div>
                <div class="component-item" draggable="true" data-type="end">
                  <div class="component-icon">ğŸ</div>
                  <span>Finalizar</span>
                </div>
              </div>
            </div>

            <div class="component-category">
              <h5>ğŸ› ï¸ Acciones</h5>
              <div class="component-group">
                <div
                  class="component-item"
                  draggable="true"
                  data-type="set-variable"
                >
                  <div class="component-icon">ğŸ“</div>
                  <span>Establecer Variable</span>
                </div>
                <div
                  class="component-item"
                  draggable="true"
                  data-type="api-call"
                >
                  <div class="component-icon">ğŸŒ</div>
                  <span>Llamada API</span>
                </div>
                <div class="component-item" draggable="true" data-type="log">
                  <div class="component-icon">ğŸ“Š</div>
                  <span>Log/Debug</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Canvas principal -->
          <div class="canvas-container">
            <svg id="connections-svg" class="connections-layer">
              <defs>
                <marker
                  id="arrowhead"
                  markerWidth="10"
                  markerHeight="7"
                  refX="9"
                  refY="3.5"
                  orient="auto"
                >
                  <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                </marker>
              </defs>
            </svg>
            <div id="visual-canvas" class="visual-canvas">
              <!-- Los nodos se agregarÃ¡n aquÃ­ dinÃ¡micamente -->
            </div>
          </div>

          <!-- Panel de propiedades -->
          <div class="properties-panel">
            <h4>âš™ï¸ Propiedades</h4>
            <div id="properties-content" class="properties-content">
              <div class="no-selection">
                <i class="fas fa-mouse-pointer"></i>
                <p>Selecciona un nodo para editar sus propiedades</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TAB 3: PrevisualizaciÃ³n -->
    <div class="tab-content" id="preview-tab">
      <div class="preview-container">
        <h3 class="section-title">ğŸ‘ï¸ PrevisualizaciÃ³n del Flujo</h3>

        <div
          id="validationErrors"
          class="validation-errors"
          style="display: none"
        >
          <strong>âŒ Errores de validaciÃ³n:</strong>
          <ul id="errorsList"></ul>
        </div>

        <div
          id="validationSuccess"
          class="validation-success"
          style="display: none"
        >
          <strong>âœ… CDU validado correctamente</strong>
        </div>

        <div class="chat-preview" id="chatPreview">
          <div class="chat-header-preview">
            <i class="fas fa-robot"></i> Movistar Empresas Bot
          </div>
          <div id="previewContent">
            <p style="text-align: center; color: #666; margin-top: 100px">
              Completa la configuraciÃ³n y presiona "Previsualizar" para ver cÃ³mo
              se verÃ¡ tu CDU
            </p>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button
            class="btn btn-primary"
            onclick="CDUBuilder.showTab('config')"
          >
            â¬…ï¸ Editar
          </button>
          <button class="btn btn-success" onclick="CDUBuilder.showTab('code')">
            ğŸ“„ Ver CÃ³digo
          </button>
        </div>
      </div>
    </div>

    <!-- TAB 4: CÃ³digo Generado -->
    <div class="tab-content" id="code-tab">
      <div class="builder-section">
        <h3 class="section-title">ğŸ“„ CÃ³digo Generado</h3>

        <div style="margin-bottom: 20px">
          <button
            class="btn btn-primary"
            onclick="CDUBuilder.validateAndGenerate()"
          >
            ğŸ”„ Regenerar CÃ³digo
          </button>
          <button class="btn btn-success" onclick="CDUBuilder.downloadCode()">
            ğŸ’¾ Descargar Archivo
          </button>
          <button class="btn btn-secondary" onclick="CDUBuilder.copyCode()">
            ğŸ“‹ Copiar
          </button>
          <button
            class="btn btn-primary"
            onclick="CDUBuilder.showTab('deploy')"
          >
            ğŸš€ Ir a Despliegue
          </button>
        </div>

        <div id="statusMessage"></div>
        <div class="code-output" id="codeOutput">
          Genera el cÃ³digo para ver el resultado aquÃ­...
        </div>
      </div>
    </div>

    <!-- TAB 5: Despliegue -->
    <div class="tab-content" id="deploy-tab">
      <div class="deploy-section">
        <h3 class="section-title">ğŸš€ Despliegue en el Emulador</h3>

        <div class="deploy-status" id="deployStatus">
          <i class="fas fa-info-circle"></i>
          <p>Genera y valida tu CDU para poder desplegarlo</p>
        </div>

        <div class="deploy-actions" id="deployActions">
          <button
            class="btn btn-success"
            id="testDeployBtn"
            onclick="CDUBuilder.testDeploy()"
            style="display: none"
          >
            ğŸ§ª Prueba en Temporal
          </button>
          <button
            class="btn btn-primary"
            id="fullDeployBtn"
            onclick="CDUBuilder.fullDeploy()"
            style="display: none"
          >
            ğŸš€ Desplegar Definitivo
          </button>
          <button
            class="btn btn-secondary"
            onclick="CDUBuilder.showTab('code')"
          >
            â¬…ï¸ Volver al CÃ³digo
          </button>
        </div>

        <div id="deployResults" style="margin-top: 20px"></div>
      </div>
    </div>

    <!-- Scripts modulares -->
    <script src="js/config.js"></script>
    <script src="js/templates.js"></script>
    <script src="js/validator.js"></script>
    <script src="js/code-generator.js"></script>
    <script src="js/preview.js"></script>
    <script src="js/deploy.js"></script>
    <script src="js/app.js"></script>

    <!-- Scripts del Editor Visual -->
    <script src="visual-editor/visual-editor-config.js"></script>
    <script src="visual-editor/visual-node-manager.js"></script>
    <script src="visual-editor/visual-connection-manager.js"></script>
    <script src="visual-editor/visual-drag-drop.js"></script>
    <script src="visual-editor/visual-components-panel.js"></script>
    <script src="visual-editor/visual-properties-panel.js"></script>
    <script src="visual-editor/visual-validation-panel.js"></script>
    <script src="visual-editor/visual-flow-converter.js"></script>
    <script src="visual-editor/visual-editor.js"></script>

    <!-- InicializaciÃ³n -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Iniciando CDU Builder Pro...");
        CDUBuilder.init();

        // Verificar que todos los mÃ³dulos del editor visual estÃ©n cargados
        const visualModules = [
          "VisualEditorConfig",
          "VisualNodeManager",
          "VisualConnectionManager",
          "VisualDragDrop",
          "VisualComponentsPanel",
          "VisualPropertiesPanel",
          "VisualValidationPanel",
          "VisualFlowConverter",
          "VisualEditor",
        ];

        let allLoaded = true;
        visualModules.forEach((module) => {
          if (!window[module]) {
            console.error("MÃ³dulo no cargado:", module);
            allLoaded = false;
          }
        });

        if (allLoaded) {
          console.log(
            "âœ… Todos los mÃ³dulos del editor visual cargados correctamente"
          );
        } else {
          console.warn("âš ï¸ Algunos mÃ³dulos del editor visual no se cargaron");
        }
      });
    </script>
  </body>
</html>

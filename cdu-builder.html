<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß CDU Builder Pro - Generador y Previsualizador de Flujos</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        .builder-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .builder-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        
        .builder-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .builder-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .builder-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        
        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
        }
        
        .btn-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #718096;
        }
        
        .options-container {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .option-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .option-item input {
            flex: 2;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .option-item select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }
        
        .output-section {
            grid-column: 1 / -1;
        }
        
        .code-output {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .template-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        /* Estilos para pesta√±as */
        .tabs-container {
            margin-bottom: 30px;
        }
        
        .tabs-nav {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        
        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            color: #64748b;
        }
        
        .tab-btn:hover {
            color: #475569;
            background: #f1f5f9;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Preview styles */
        .preview-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        
        .chat-preview {
            max-width: 400px;
            margin: 0 auto;
            background: #f0f2f5;
            border-radius: 20px;
            padding: 20px;
            min-height: 500px;
            position: relative;
        }
        
        .chat-header-preview {
            background: #25d366;
            color: white;
            padding: 15px;
            border-radius: 15px 15px 0 0;
            margin: -20px -20px 20px -20px;
            text-align: center;
            font-weight: bold;
        }
        
        .message-preview {
            background: white;
            padding: 12px 16px;
            border-radius: 18px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .message-preview:before {
            content: '';
            position: absolute;
            left: -8px;
            top: 15px;
            border: 8px solid transparent;
            border-right-color: white;
        }
        
        .options-preview {
            margin-top: 15px;
        }
        
        .option-preview {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 12px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #bbdefb;
        }
        
        .option-preview:hover {
            background: #bbdefb;
        }
        
        /* Deploy styles */
        .deploy-section {
            text-align: center;
            padding: 30px;
        }
        
        .deploy-status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 20px;
            border-radius: 12px;
            border: 2px dashed #d1d5db;
        }
        
        .deploy-status.ready {
            background: #dcfce7;
            border-color: #16a34a;
            color: #15803d;
        }
        
        .deploy-status.deployed {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1d4ed8;
        }
        
        .deploy-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Validation styles */
        .validation-errors {
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #991b1b;
        }
        
        .validation-errors ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .validation-success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #166534;
        }
        
        @media (max-width: 768px) {
            .builder-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .builder-header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="builder-header">
        <h1>üîß CDU Builder Pro</h1>
        <p>Generador, Previsualizador y Desplegador Autom√°tico de Flujos - WhatsApp Bot Movistar Empresas</p>
    </div>

    <!-- Navegaci√≥n por pesta√±as -->
    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="config">‚öôÔ∏è Configuraci√≥n</button>
            <button class="tab-btn" data-tab="visual">üé® Editor Visual</button>
            <button class="tab-btn" data-tab="preview">üëÅÔ∏è Previsualizaci√≥n</button>
            <button class="tab-btn" data-tab="code">üìÑ C√≥digo</button>
            <button class="tab-btn" data-tab="deploy">üöÄ Despliegue</button>
        </div>
    </div>

    <!-- TAB 1: Configuraci√≥n -->
    <div class="tab-content active" id="config-tab">
        <div class="builder-container">
            <!-- Configuraci√≥n B√°sica -->
            <div class="builder-section">
                <h3 class="section-title">
                    ‚öôÔ∏è Configuraci√≥n B√°sica
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Nombre del CDU (sin espacios) *:</label>
                    <input type="text" id="cduName" class="form-input" placeholder="ej: soporte_tecnico" required>
                    <small style="color: #666;">Solo letras, n√∫meros y guiones bajos</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">T√≠tulo para mostrar *:</label>
                    <input type="text" id="cduTitle" class="form-input" placeholder="ej: CDU Soporte T√©cnico" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n breve *:</label>
                    <input type="text" id="cduDescription" class="form-input" placeholder="ej: Asistencia t√©cnica especializada" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Icono (Font Awesome):</label>
                    <input type="text" id="cduIcon" class="form-input" placeholder="ej: fas fa-tools" value="fas fa-cog">
                    <small style="color: #666;">Busca √≠conos en <a href="https://fontawesome.com/icons" target="_blank">FontAwesome</a></small>
                </div>
            </div>

            <!-- Mensajes y Opciones -->
            <div class="builder-section">
                <h3 class="section-title">
                    üí¨ Contenido del Flujo
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Mensaje inicial *:</label>
                    <textarea id="initialMessage" class="form-input form-textarea" placeholder="¬°Hola! Te ayudo con..." required></textarea>
                    <small style="color: #666;">Este ser√° el primer mensaje que vea el usuario</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mensaje adicional (opcional):</label>
                    <textarea id="secondMessage" class="form-input form-textarea" placeholder="Selecciona una opci√≥n..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Opciones de respuesta *:</label>
                    <div class="options-container" id="optionsContainer">
                        <div class="option-item">
                            <input type="text" placeholder="Texto de la opci√≥n" class="option-text" required>
                            <input type="text" placeholder="Acci√≥n (ej: siguiente_paso)" class="option-action" required>
                            <button type="button" class="btn btn-secondary" onclick="removeOption(this)">‚ùå</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addOption()">‚ûï Agregar Opci√≥n</button>
                    <small style="color: #666;">Al menos una opci√≥n es requerida</small>
                </div>
            </div>

            <!-- Plantillas R√°pidas -->
            <div class="builder-section">
                <h3 class="section-title">
                    üìã Plantillas R√°pidas
                </h3>
                
                <div class="template-buttons">
                    <button class="btn btn-primary" onclick="loadTemplate('soporte')">üîß Soporte T√©cnico</button>
                    <button class="btn btn-primary" onclick="loadTemplate('facturacion')">üí∞ Facturaci√≥n</button>
                    <button class="btn btn-primary" onclick="loadTemplate('comercial')">üõçÔ∏è Comercial</button>
                    <button class="btn btn-primary" onclick="loadTemplate('reclamos')">üìû Reclamos</button>
                </div>
            </div>

            <!-- Configuraci√≥n Avanzada -->
            <div class="builder-section">
                <h3 class="section-title">
                    üéõÔ∏è Configuraci√≥n Avanzada
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Autor:</label>
                    <input type="text" id="author" class="form-input" placeholder="Tu nombre" value="CDU Builder Pro">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Versi√≥n:</label>
                    <input type="text" id="version" class="form-input" placeholder="1.0" value="1.0">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableStats"> Habilitar estad√≠sticas de uso
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableLogging" checked> Habilitar logging de debug
                    </label>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="validateAndPreview()">üëÅÔ∏è Previsualizar</button>
                    <button class="btn btn-success" onclick="validateAndGenerate()">üìÑ Generar C√≥digo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: Editor Visual -->
    <div class="tab-content" id="visual-tab">
        <div id="visual-editor-container">
            <!-- Se cargar√° din√°micamente -->
        </div>
    </div>

    <!-- TAB 3: Previsualizaci√≥n -->
    <div class="tab-content" id="preview-tab">
        <div class="preview-container">
            <h3 class="section-title">üëÅÔ∏è Previsualizaci√≥n del Flujo</h3>
            
            <div id="validationErrors" class="validation-errors" style="display: none;">
                <strong>‚ùå Errores de validaci√≥n:</strong>
                <ul id="errorsList"></ul>
            </div>
            
            <div id="validationSuccess" class="validation-success" style="display: none;">
                <strong>‚úÖ CDU validado correctamente</strong>
            </div>
            
            <div class="chat-preview" id="chatPreview">
                <div class="chat-header-preview">
                    <i class="fas fa-robot"></i> Movistar Empresas Bot
                </div>
                <div id="previewContent">
                    <p style="text-align: center; color: #666; margin-top: 100px;">
                        Completa la configuraci√≥n y presiona "Previsualizar" para ver c√≥mo se ver√° tu CDU
                    </p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="showTab('config')">‚¨ÖÔ∏è Editar</button>
                <button class="btn btn-success" onclick="showTab('code')">üìÑ Ver C√≥digo</button>
            </div>
        </div>
    </div>

    <!-- TAB 3: C√≥digo Generado -->
    <div class="tab-content" id="code-tab">
        <div class="builder-section output-section">
            <h3 class="section-title">
                üìÑ C√≥digo Generado
            </h3>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="validateAndGenerate()">ÔøΩ Regenerar C√≥digo</button>
                <button class="btn btn-success" onclick="downloadCode()">üíæ Descargar Archivo</button>
                <button class="btn btn-secondary" onclick="copyCode()">üìã Copiar</button>
                <button class="btn btn-primary" onclick="showTab('deploy')">ÔøΩ Ir a Despliegue</button>
            </div>
            
            <div id="statusMessage"></div>
            <div class="code-output" id="codeOutput">Genera el c√≥digo para ver el resultado aqu√≠...</div>
        </div>
    </div>

    <!-- TAB 4: Despliegue -->
    <div class="tab-content" id="deploy-tab">
        <div class="deploy-section">
            <h3 class="section-title">üöÄ Despliegue en el Emulador</h3>
            
            <div class="deploy-status" id="deployStatus">
                <i class="fas fa-info-circle"></i>
                <p>Genera y valida tu CDU para poder desplegarlo</p>
            </div>
            
            <div class="deploy-actions" id="deployActions">
                <button class="btn btn-success" id="testDeployBtn" onclick="testDeploy()" style="display: none;">
                    üß™ Prueba en Temporal
                </button>
                <button class="btn btn-primary" id="fullDeployBtn" onclick="fullDeploy()" style="display: none;">
                    üöÄ Desplegar Definitivo
                </button>
                <button class="btn btn-secondary" onclick="showTab('code')">‚¨ÖÔ∏è Volver al C√≥digo</button>
            </div>
            
            <div id="deployResults" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Estado global de la aplicaci√≥n
        const AppState = {
            currentCDU: null,
            isValid: false,
            generatedCode: null,
            isDeployed: false
        };

        // Plantillas predefinidas mejoradas
        const templates = {
            soporte: {
                name: 'soporte_tecnico',
                title: 'CDU Soporte T√©cnico',
                description: 'Asistencia t√©cnica especializada',
                icon: 'fas fa-tools',
                initialMessage: 'üîß ¬°Hola! Soy tu asistente de soporte t√©cnico de Movistar Empresas.\\n\\n¬øEn qu√© puedo ayudarte hoy?',
                secondMessage: 'Selecciona el tipo de problema que est√°s experimentando:',
                options: [
                    { text: 'Problemas de conexi√≥n a Internet', action: 'soporte_conexion' },
                    { text: 'Configuraci√≥n de equipos', action: 'soporte_equipos' },
                    { text: 'Problemas con l√≠neas telef√≥nicas', action: 'soporte_lineas' },
                    { text: 'Consultas t√©cnicas avanzadas', action: 'soporte_avanzado' },
                    { text: 'Hablar con t√©cnico especializado', action: 'transfer_tecnico' },
                    { text: 'üîô Volver al men√∫ principal', action: 'welcome' }
                ]
            },
            facturacion: {
                name: 'consultas_facturacion',
                title: 'CDU Consultas Facturaci√≥n',
                description: 'Consultas sobre facturaci√≥n y pagos',
                icon: 'fas fa-file-invoice-dollar',
                initialMessage: 'üí∞ ¬°Hola! Te ayudo con todas tus consultas de facturaci√≥n y pagos.',
                secondMessage: '¬øQu√© necesitas hacer hoy?',
                options: [
                    { text: 'Ver mi √∫ltima factura', action: 'ver_ultima_factura' },
                    { text: 'Descargar facturas anteriores', action: 'descargar_facturas' },
                    { text: 'Consultar estado de pagos', action: 'estado_pagos' },
                    { text: 'Reportar problema de cobro', action: 'reclamo_cobro' },
                    { text: 'Configurar d√©bito autom√°tico', action: 'config_debito' },
                    { text: 'üîô Volver al men√∫ principal', action: 'welcome' }
                ]
            },
            comercial: {
                name: 'atencion_comercial',
                title: 'CDU Atenci√≥n Comercial',
                description: 'Servicios, ofertas y upgrades',
                icon: 'fas fa-handshake',
                initialMessage: 'üõçÔ∏è ¬°Hola! Soy tu asesor comercial virtual de Movistar Empresas.',
                secondMessage: 'Te ayudo a encontrar las mejores soluciones para tu empresa:',
                options: [
                    { text: 'Nuevos servicios de Internet', action: 'servicios_internet' },
                    { text: 'Planes m√≥viles empresariales', action: 'planes_moviles' },
                    { text: 'Soluciones de telefon√≠a fija', action: 'telefonia_fija' },
                    { text: 'Upgrades de plan actual', action: 'upgrade_plan' },
                    { text: 'Ofertas y promociones vigentes', action: 'ofertas_actuales' },
                    { text: 'Hablar con asesor comercial', action: 'transfer_comercial' },
                    { text: 'üîô Volver al men√∫ principal', action: 'welcome' }
                ]
            },
            reclamos: {
                name: 'gestion_reclamos',
                title: 'CDU Gesti√≥n de Reclamos',
                description: 'Gesti√≥n y seguimiento de reclamos',
                icon: 'fas fa-exclamation-triangle',
                initialMessage: 'üìû ¬°Hola! Lamento que hayas tenido inconvenientes.\\n\\nEstoy aqu√≠ para ayudarte a resolver tu situaci√≥n.',
                secondMessage: '¬øQu√© tipo de reclamo necesitas hacer?',
                options: [
                    { text: 'Reclamo por facturaci√≥n incorrecta', action: 'reclamo_facturacion' },
                    { text: 'Falla o interrupci√≥n de servicio', action: 'reclamo_servicio' },
                    { text: 'Problema con atenci√≥n recibida', action: 'reclamo_atencion' },
                    { text: 'Demora en instalaci√≥n/reparaci√≥n', action: 'reclamo_demora' },
                    { text: 'Seguimiento de reclamo existente', action: 'seguimiento_reclamo' },
                    { text: 'Escalamiento a supervisor', action: 'escalamiento' },
                    { text: 'üîô Volver al men√∫ principal', action: 'welcome' }
                ]
            }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            setupTabNavigation();
            addOption(); // Agregar una opci√≥n por defecto
            showStatus('CDU Builder Pro cargado correctamente', 'success');
        });

        // Navegaci√≥n por pesta√±as
        function setupTabNavigation() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetTab = btn.getAttribute('data-tab');
                    showTab(targetTab);
                });
            });
        }

        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar la pesta√±a seleccionada
            const targetTab = document.getElementById(tabName + '-tab');
            const targetBtn = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (targetTab && targetBtn) {
                targetTab.classList.add('active');
                targetBtn.classList.add('active');
            }
        }

        // Gesti√≥n de opciones
        function addOption() {
            const container = document.getElementById('optionsContainer');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.innerHTML = `
                <input type="text" placeholder="Texto de la opci√≥n" class="option-text" required>
                <input type="text" placeholder="Acci√≥n (ej: siguiente_paso)" class="option-action" required>
                <button type="button" class="btn btn-secondary" onclick="removeOption(this)">‚ùå</button>
            `;
            container.appendChild(optionDiv);
        }

        function removeOption(button) {
            const optionItems = document.querySelectorAll('.option-item');
            if (optionItems.length > 1) {
                button.parentElement.remove();
            } else {
                showStatus('Debe haber al menos una opci√≥n', 'error');
            }
        }

        // Carga de plantillas
        function loadTemplate(templateName) {
            const template = templates[templateName];
            if (!template) {
                showStatus('Plantilla no encontrada', 'error');
                return;
            }

            try {
                document.getElementById('cduName').value = template.name;
                document.getElementById('cduTitle').value = template.title;
                document.getElementById('cduDescription').value = template.description;
                document.getElementById('cduIcon').value = template.icon;
                document.getElementById('initialMessage').value = template.initialMessage.replace(/\\\\n/g, '\\n');
                document.getElementById('secondMessage').value = template.secondMessage || '';

                // Limpiar opciones actuales
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';

                // Agregar opciones de la plantilla
                template.options.forEach(option => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item';
                    optionDiv.innerHTML = `
                        <input type="text" placeholder="Texto de la opci√≥n" class="option-text" value="${option.text}" required>
                        <input type="text" placeholder="Acci√≥n (ej: siguiente_paso)" class="option-action" value="${option.action}" required>
                        <button type="button" class="btn btn-secondary" onclick="removeOption(this)">‚ùå</button>
                    `;
                    container.appendChild(optionDiv);
                });

                AppState.currentCDU = collectFormData();
                showStatus(`Plantilla "${template.title}" cargada correctamente`, 'success');
                
            } catch (error) {
                showStatus(`Error cargando plantilla: ${error.message}`, 'error');
            }
        }

        // Validaci√≥n robusta
        function validateCDU() {
            const errors = [];
            const data = collectFormData();

            // Validaciones obligatorias
            if (!data.cduName) errors.push('El nombre del CDU es obligatorio');
            if (!data.cduTitle) errors.push('El t√≠tulo es obligatorio');
            if (!data.cduDescription) errors.push('La descripci√≥n es obligatoria');
            if (!data.initialMessage) errors.push('El mensaje inicial es obligatorio');
            if (data.options.length === 0) errors.push('Debe haber al menos una opci√≥n');

            // Validaciones de formato
            if (data.cduName && !/^[a-z0-9_]+$/.test(data.cduName)) {
                errors.push('El nombre del CDU solo puede contener letras min√∫sculas, n√∫meros y guiones bajos');
            }

            if (data.cduName && data.cduName.length > 50) {
                errors.push('El nombre del CDU no puede tener m√°s de 50 caracteres');
            }

            // Validar opciones
            data.options.forEach((option, index) => {
                if (!option.text) errors.push(`La opci√≥n ${index + 1} debe tener texto`);
                if (!option.action) errors.push(`La opci√≥n ${index + 1} debe tener una acci√≥n`);
                if (option.action && !/^[a-z0-9_]+$/.test(option.action)) {
                    errors.push(`La acci√≥n de la opci√≥n ${index + 1} solo puede contener letras min√∫sculas, n√∫meros y guiones bajos`);
                }
            });

            // Validar duplicados
            const optionTexts = data.options.map(opt => opt.text);
            const duplicateTexts = optionTexts.filter((text, index) => optionTexts.indexOf(text) !== index);
            if (duplicateTexts.length > 0) {
                errors.push('Hay opciones con texto duplicado');
            }

            const optionActions = data.options.map(opt => opt.action);
            const duplicateActions = optionActions.filter((action, index) => optionActions.indexOf(action) !== index);
            if (duplicateActions.length > 0) {
                errors.push('Hay opciones con acciones duplicadas');
            }

            return {
                isValid: errors.length === 0,
                errors: errors,
                data: data
            };
        }

        function collectFormData() {
            const options = [];
            const optionItems = document.querySelectorAll('.option-item');
            
            optionItems.forEach(item => {
                const text = item.querySelector('.option-text').value.trim();
                const action = item.querySelector('.option-action').value.trim();
                
                if (text && action) {
                    options.push({ text, action });
                }
            });

            return {
                cduName: document.getElementById('cduName').value.trim(),
                cduTitle: document.getElementById('cduTitle').value.trim(),
                cduDescription: document.getElementById('cduDescription').value.trim(),
                cduIcon: document.getElementById('cduIcon').value.trim() || 'fas fa-cog',
                initialMessage: document.getElementById('initialMessage').value.trim(),
                secondMessage: document.getElementById('secondMessage').value.trim(),
                options: options,
                author: document.getElementById('author').value.trim() || 'CDU Builder Pro',
                version: document.getElementById('version').value.trim() || '1.0',
                enableStats: document.getElementById('enableStats').checked,
                enableLogging: document.getElementById('enableLogging').checked
            };
        }

        // Previsualizaci√≥n
        function validateAndPreview() {
            const validation = validateCDU();
            
            if (!validation.isValid) {
                showValidationErrors(validation.errors);
                showTab('preview');
                return;
            }

            hideValidationErrors();
            showValidationSuccess();
            renderPreview(validation.data);
            AppState.currentCDU = validation.data;
            AppState.isValid = true;
            showTab('preview');
        }

        function showValidationErrors(errors) {
            const errorsContainer = document.getElementById('validationErrors');
            const errorsList = document.getElementById('errorsList');
            const successContainer = document.getElementById('validationSuccess');
            
            errorsList.innerHTML = errors.map(error => `<li>${error}</li>`).join('');
            errorsContainer.style.display = 'block';
            successContainer.style.display = 'none';
        }

        function hideValidationErrors() {
            document.getElementById('validationErrors').style.display = 'none';
        }

        function showValidationSuccess() {
            document.getElementById('validationSuccess').style.display = 'block';
        }

        function renderPreview(data) {
            const previewContent = document.getElementById('previewContent');
            
            let messagesHTML = '';
            if (data.initialMessage) {
                messagesHTML += `<div class="message-preview">${data.initialMessage.replace(/\\n/g, '<br>')}</div>`;
            }
            if (data.secondMessage) {
                messagesHTML += `<div class="message-preview">${data.secondMessage.replace(/\\n/g, '<br>')}</div>`;
            }

            let optionsHTML = '<div class="options-preview">';
            data.options.forEach(option => {
                optionsHTML += `<div class="option-preview" onclick="previewOptionClick('${option.action}')">
                    ${option.text}
                </div>`;
            });
            optionsHTML += '</div>';

            previewContent.innerHTML = messagesHTML + optionsHTML;
        }

        function previewOptionClick(action) {
            showStatus(`Opci√≥n seleccionada: ${action}`, 'success');
        }

        // Generaci√≥n de c√≥digo
        function validateAndGenerate() {
            const validation = validateCDU();
            
            if (!validation.isValid) {
                showValidationErrors(validation.errors);
                showTab('preview');
                return;
            }

            try {
                const code = generateCDUCode(validation.data);
                document.getElementById('codeOutput').textContent = code;
                AppState.generatedCode = code;
                AppState.currentCDU = validation.data;
                AppState.isValid = true;
                
                updateDeployStatus();
                showStatus(`CDU "${validation.data.cduName}" generado correctamente`, 'success');
                
            } catch (error) {
                showStatus(`Error al generar c√≥digo: ${error.message}`, 'error');
            }
        }

        function generateCDUCode(config) {
            const {
                cduName,
                cduTitle,
                cduDescription,
                cduIcon,
                initialMessage,
                secondMessage,
                options,
                author,
                version,
                enableStats,
                enableLogging
            } = config;

            const date = new Date().toLocaleDateString('es-ES');
            const messages = [initialMessage.replace(/\\n/g, '\\\\n')];
            if (secondMessage) messages.push(secondMessage.replace(/\\n/g, '\\\\n'));

            return `// ========================================
// ${cduTitle.toUpperCase()}
// ========================================
// Autor: ${author}
// Fecha: ${date}
// Versi√≥n: ${version}
// Descripci√≥n: ${cduDescription}
// Generado con: CDU Builder Pro
// ========================================

${enableLogging ? `console.log('üì¶ Cargando ${cduTitle}...');` : ''}

// Configuraci√≥n del CDU
const CDU_${cduName.toUpperCase()}_CONFIG = {
  name: '${cduName}',
  title: '${cduTitle}',
  description: '${cduDescription}',
  icon: '${cduIcon}',
  version: '${version}',
  author: '${author}',
  enabled: true,
  ${enableStats ? 'trackStats: true,' : 'trackStats: false,'}
  ${enableLogging ? 'enableLogging: true' : 'enableLogging: false'}
};

// Definici√≥n del flujo principal
const FLUJO_${cduName.toUpperCase()} = {
  // Paso inicial
  ${cduName}: {
    messages: [
${messages.map(msg => `      "${msg}"`).join(',\\n')}
    ],
    options: [
${options.map(opt => `      { text: "${opt.text.replace(/"/g, '\\\\"')}", action: "${opt.action}" }`).join(',\\n')}
    ]
  }
  
  // TODO: Agregar aqu√≠ los pasos adicionales del flujo
  // Ejemplo:
  // ${options[0]?.action || 'next_step'}: {
  //   messages: ["Mensaje del siguiente paso"],
  //   options: [
  //     { text: "Continuar", action: "otro_paso" },
  //     { text: "Volver", action: "${cduName}" }
  //   ]
  // }
};

// Funci√≥n de inicializaci√≥n del CDU
function init${formatFunctionName(cduName)}CDU() {
  ${enableLogging ? `console.log('üöÄ Inicializando ${cduTitle}...');` : ''}
  
  // Verificar que el bot principal est√© disponible
  if (typeof window === 'undefined' || !window.bot) {
    console.error('‚ùå Bot principal no encontrado. Aseg√∫rate de cargar este CDU despu√©s del script principal.');
    return false;
  }
  
  try {
    // Registrar el flujo en el bot principal
    Object.keys(FLUJO_${cduName.toUpperCase()}).forEach(stepName => {
      window.bot.addFlow(stepName, FLUJO_${cduName.toUpperCase()}[stepName]);
      ${enableLogging ? `console.log(\`üìù Paso "\${stepName}" registrado\`);` : ''}
    });
    
    ${enableStats ? `
    // Registrar estad√≠sticas si est√° habilitado
    if (window.bot.statsManager) {
      window.bot.statsManager.registerCDU('${cduName}', '${cduTitle}');
    }` : ''}
    
    ${enableLogging ? `console.log('‚úÖ ${cduTitle} cargado correctamente');` : ''}
    return true;
    
  } catch (error) {
    console.error('‚ùå Error inicializando ${cduTitle}:', error);
    return false;
  }
}

// Auto-inicializaci√≥n cuando se carga el script
document.addEventListener('DOMContentLoaded', () => {
  // Esperar a que el bot est√© completamente inicializado
  let attempts = 0;
  const maxAttempts = 50; // 5 segundos m√°ximo
  
  const initInterval = setInterval(() => {
    attempts++;
    
    if (typeof window !== 'undefined' && window.bot) {
      clearInterval(initInterval);
      const success = init${formatFunctionName(cduName)}CDU();
      if (success) {
        ${enableLogging ? `console.log('üéØ ${cduTitle} integrado al sistema');` : ''}
      }
    } else if (attempts >= maxAttempts) {
      clearInterval(initInterval);
      console.error('‚ùå Timeout: No se pudo conectar con el bot principal');
    }
  }, 100);
});

// Exportar para uso externo si es necesario
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    config: CDU_${cduName.toUpperCase()}_CONFIG,
    flows: FLUJO_${cduName.toUpperCase()},
    init: init${formatFunctionName(cduName)}CDU
  };
}

${enableLogging ? `console.log('üì¶ ${cduTitle} definido y listo para usar');` : ''}

// ========================================
// INSTRUCCIONES DE INSTALACI√ìN:
// ========================================
// 1. Guarda este archivo como "cdu-${cduName}.js" en la carpeta /flujos/
// 2. Agrega la referencia en index.html: 
//    <script src="flujos/cdu-${cduName}.js"></script>
// 3. Agrega el bot√≥n en el HTML del selector CDU:
//    <button class="cdu-btn" data-cdu="${cduName}">
//      <i class="${cduIcon}"></i>
//      <span>${cduTitle}</span>
//      <small>${cduDescription}</small>
//    </button>
// 4. ¬°Listo! El CDU estar√° disponible en la interfaz
// ========================================`;
        }

        function formatFunctionName(cduName) {
            return cduName.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join('');
        }

        // Funciones de archivo
        function downloadCode() {
            const code = document.getElementById('codeOutput').textContent;
            
            if (!AppState.generatedCode || code === 'Genera el c√≥digo para ver el resultado aqu√≠...') {
                showStatus('Primero genera el c√≥digo antes de descargarlo', 'error');
                return;
            }
            
            const cduName = AppState.currentCDU?.cduName || 'mi_cdu';
            
            try {
                const blob = new Blob([code], { type: 'text/javascript' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cdu-${cduName}.js`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Archivo descargado correctamente', 'success');
            } catch (error) {
                showStatus(`Error al descargar: ${error.message}`, 'error');
            }
        }

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            
            if (!AppState.generatedCode) {
                showStatus('Primero genera el c√≥digo antes de copiarlo', 'error');
                return;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                showStatus('C√≥digo copiado al portapapeles', 'success');
            }).catch(() => {
                showStatus('Error al copiar c√≥digo', 'error');
            });
        }

        // Sistema de despliegue
        function updateDeployStatus() {
            const deployStatus = document.getElementById('deployStatus');
            const testBtn = document.getElementById('testDeployBtn');
            const fullBtn = document.getElementById('fullDeployBtn');
            
            if (AppState.isValid && AppState.generatedCode) {
                deployStatus.className = 'deploy-status ready';
                deployStatus.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <p><strong>‚úÖ CDU listo para despliegue</strong></p>
                    <p>CDU: <strong>${AppState.currentCDU.cduTitle}</strong></p>
                    <p>Nombre: <code>${AppState.currentCDU.cduName}</code></p>
                `;
                testBtn.style.display = 'inline-flex';
                fullBtn.style.display = 'inline-flex';
            }
        }

        function testDeploy() {
            if (!AppState.isValid || !AppState.generatedCode) {
                showStatus('CDU no v√°lido para despliegue', 'error');
                return;
            }

            try {
                // Verificar si el emulador est√° disponible
                if (window.opener && window.opener.bot) {
                    // Crear un CDU temporal en el emulador
                    const tempFlow = createFlowFromCDU(AppState.currentCDU);
                    window.opener.bot.addFlow(AppState.currentCDU.cduName, tempFlow);
                    
                    // Actualizar selector si existe
                    if (window.opener.bot.cduSelector) {
                        window.opener.bot.cduSelector.updateCDUList();
                    }
                    
                    showDeployResult('success', 'üß™ CDU desplegado temporalmente en el emulador', 
                        'El CDU est√° ahora disponible para pruebas. Se eliminar√° al recargar la p√°gina.');
                    
                } else {
                    showDeployResult('error', '‚ùå Emulador no encontrado', 
                        'Abre esta herramienta desde la ventana del emulador principal.');
                }
                
            } catch (error) {
                showDeployResult('error', '‚ùå Error en despliegue temporal', error.message);
            }
        }

        function fullDeploy() {
            if (!AppState.isValid || !AppState.generatedCode) {
                showStatus('CDU no v√°lido para despliegue', 'error');
                return;
            }

            // Crear instrucciones de instalaci√≥n manual
            const instructions = generateInstallationInstructions();
            showDeployResult('info', 'üìã Instrucciones de instalaci√≥n', instructions);
        }

        function createFlowFromCDU(cdu) {
            const messages = [cdu.initialMessage];
            if (cdu.secondMessage) messages.push(cdu.secondMessage);
            
            return {
                messages: messages,
                options: cdu.options
            };
        }

        function generateInstallationInstructions() {
            const cdu = AppState.currentCDU;
            return `
                <div style="text-align: left; max-width: 600px;">
                    <h4>üöÄ Para instalar permanentemente tu CDU:</h4>
                    <ol>
                        <li><strong>Descargar:</strong> Usa el bot√≥n "üíæ Descargar Archivo" para obtener <code>cdu-${cdu.cduName}.js</code></li>
                        <li><strong>Guardar:</strong> Coloca el archivo en la carpeta <code>/flujos/</code></li>
                        <li><strong>HTML:</strong> Agrega en <code>index.html</code> antes del <code>&lt;/body&gt;</code>:
                            <pre style="background: #f4f4f4; padding: 10px; margin: 10px 0; border-radius: 5px; overflow-x: auto;">&lt;script src="flujos/cdu-${cdu.cduName}.js"&gt;&lt;/script&gt;</pre>
                        </li>
                        <li><strong>Bot√≥n:</strong> Agrega en el selector CDU:
                            <pre style="background: #f4f4f4; padding: 10px; margin: 10px 0; border-radius: 5px; overflow-x: auto;">&lt;button class="cdu-btn" data-cdu="${cdu.cduName}"&gt;
  &lt;i class="${cdu.cduIcon}"&gt;&lt;/i&gt;
  &lt;span&gt;${cdu.cduTitle}&lt;/span&gt;
  &lt;small&gt;${cdu.cduDescription}&lt;/small&gt;
&lt;/button&gt;</pre>
                        </li>
                        <li><strong>¬°Listo!</strong> Recarga el emulador y tu CDU estar√° disponible</li>
                    </ol>
                </div>
            `;
        }

        function showDeployResult(type, title, message) {
            const deployResults = document.getElementById('deployResults');
            const className = type === 'success' ? 'status-success' : 
                             type === 'error' ? 'status-error' : 'status-message';
            
            deployResults.innerHTML = `
                <div class="${className}">
                    <strong>${title}</strong>
                    <div style="margin-top: 10px;">${message}</div>
                </div>
            `;

            if (type === 'success') {
                AppState.isDeployed = true;
                const deployStatus = document.getElementById('deployStatus');
                deployStatus.className = 'deploy-status deployed';
                deployStatus.innerHTML = `
                    <i class="fas fa-rocket"></i>
                    <p><strong>üöÄ CDU desplegado exitosamente</strong></p>
                    <p>¬°Ya est√° disponible para usar!</p>
                `;
            }
        }

        // Utilidades
        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            if (!statusDiv) return;
            
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = '';
            }, 5000);
        }

        function clearAll() {
            if (confirm('¬øEst√°s seguro de que queres limpiar todos los campos?')) {
                document.querySelectorAll('input, textarea, select').forEach(element => {
                    if (element.type === 'checkbox') {
                        element.checked = element.id === 'enableLogging';
                    } else {
                        element.value = '';
                    }
                });
                
                // Resetear valores por defecto
                document.getElementById('cduIcon').value = 'fas fa-cog';
                document.getElementById('author').value = 'CDU Builder Pro';
                document.getElementById('version').value = '1.0';
                
                // Limpiar opciones
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';
                addOption();
                
                document.getElementById('codeOutput').textContent = 'Genera el c√≥digo para ver el resultado aqu√≠...';
                document.getElementById('previewContent').innerHTML = '<p style="text-align: center; color: #666; margin-top: 100px;">Completa la configuraci√≥n y presiona "Previsualizar" para ver c√≥mo se ver√° tu CDU</p>';
                
                // Resetear estado
                AppState.currentCDU = null;
                AppState.isValid = false;
                AppState.generatedCode = null;
                AppState.isDeployed = false;
                
                showTab('config');
                showStatus('Formulario limpiado correctamente', 'success');
            }
        }

        // Inicializaci√≥n del Editor Visual
        function initializeVisualEditor() {
            const container = document.getElementById('visual-editor-container');
            if (!container) return;

            container.innerHTML = `
                <div id="visual-editor">
                    <div class="visual-editor-toolbar">
                        <div class="toolbar-section">
                            <h3>üé® Editor Visual</h3>
                            <p>Arrastra componentes para crear tu flujo</p>
                        </div>
                        <div class="toolbar-controls">
                            <button id="visual-clear" class="btn-secondary">üóëÔ∏è Limpiar</button>
                            <button id="visual-export" class="btn-primary">üì§ Exportar a Configuraci√≥n</button>
                        </div>
                    </div>
                    
                    <div class="visual-editor-workspace">
                        <div class="components-panel">
                            <h4>üì¶ Componentes</h4>
                            <div class="component-list">
                                <div class="component-item" draggable="true" data-component-type="start">
                                    <div class="component-icon">üöÄ</div>
                                    <div class="component-label">Inicio</div>
                                </div>
                                <div class="component-item" draggable="true" data-component-type="message">
                                    <div class="component-icon">üìù</div>
                                    <div class="component-label">Mensaje</div>
                                </div>
                                <div class="component-item" draggable="true" data-component-type="question">
                                    <div class="component-icon">‚ùì</div>
                                    <div class="component-label">Pregunta</div>
                                </div>
                                <div class="component-item" draggable="true" data-component-type="conditional">
                                    <div class="component-icon">üîÄ</div>
                                    <div class="component-label">Condicional</div>
                                </div>
                                <div class="component-item" draggable="true" data-component-type="action">
                                    <div class="component-icon">‚ö°</div>
                                    <div class="component-label">Acci√≥n</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="visual-canvas-container">
                            <svg id="connections-svg" class="connections-layer">
                                <defs>
                                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                                            refX="9" refY="3.5" orient="auto">
                                        <polygon points="0 0, 10 3.5, 0 7" fill="#3498db" />
                                    </marker>
                                </defs>
                            </svg>
                            <div id="visual-canvas" class="visual-canvas">
                                <div class="canvas-placeholder">
                                    <div class="placeholder-icon">üéØ</div>
                                    <div class="placeholder-text">Arrastra componentes aqu√≠ para empezar</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="properties-panel">
                            <h4>‚öôÔ∏è Propiedades</h4>
                            <div id="node-properties">
                                <p class="no-selection">Selecciona un componente para editar sus propiedades</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Manejar cambio de pesta√±as para cargar el editor visual
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            
            if (tabName === 'visual') {
                initializeVisualEditor();
                
                // Cargar scripts del editor visual si no est√°n cargados
                if (!window.VisualEditor) {
                    loadVisualEditorScripts();
                }
            }
        };

        // Cargar scripts del editor visual
        function loadVisualEditorScripts() {
            const scripts = [
                'cdu-builder/visual-editor/visual-editor-config.js',
                'cdu-builder/visual-editor/visual-components-panel.js',
                'cdu-builder/visual-editor/visual-node-manager.js',
                'cdu-builder/visual-editor/visual-connection-manager.js',
                'cdu-builder/visual-editor/visual-properties-panel.js',
                'cdu-builder/visual-editor/visual-flow-converter.js',
                'cdu-builder/visual-editor/visual-editor.js'
            ];

            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = 'cdu-builder/visual-editor/visual-editor.css';
            document.head.appendChild(css);

            let loadedCount = 0;
            scripts.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    loadedCount++;
                    if (loadedCount === scripts.length) {
                        // Todos los scripts cargados, inicializar
                        setTimeout(() => {
                            if (window.VisualEditor) {
                                window.VisualEditor.init();
                            }
                        }, 100);
                    }
                };
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>
